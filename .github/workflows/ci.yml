name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    outputs:
      duration: ${{ steps.duration.outputs.duration }}

    steps:
      - name: Record start time
        id: start-time
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@12.5
        with:
          cli: latest

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Cache Clojure dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            .cpcache
          key: ${{ runner.os }}-clojure-${{ hashFiles('deps.edn') }}
          restore-keys: |
            ${{ runner.os }}-clojure-

      - name: Install clj-kondo
        run: |
          curl -sLO https://raw.githubusercontent.com/clj-kondo/clj-kondo/master/script/install-clj-kondo
          chmod +x install-clj-kondo
          sudo ./install-clj-kondo

      - name: Lint Clojure code
        id: lint
        run: |
          echo "Running clj-kondo linter..."
          clj-kondo --lint src --config '{:output {:pattern "::{{level}} file={{filename}},line={{row}},col={{col}}::{{message}}"}}' || true

          # Also run with normal output for summary
          clj-kondo --lint src 2>&1 | tee lint-results.txt

          # Fail if there are errors (warnings are OK)
          if grep -q "errors: [1-9]" lint-results.txt; then
            echo "‚ùå Linting failed with errors"
            exit 1
          else
            echo "‚úÖ Linting passed"
          fi

      - name: Download Clojure dependencies
        run: clojure -P

      - name: Install Node dependencies
        run: npm ci

      - name: Build frontend
        run: npx shadow-cljs release app

      - name: Build CSS
        run: npm run build:css

      - name: Run backend tests
        id: backend-test
        run: |
          echo "üß™ Running backend tests..."
          clojure -M:test

      - name: Run frontend tests
        id: frontend-test
        run: |
          echo "üß™ Running frontend tests..."
          npx shadow-cljs compile test
          node target/test.js

      - name: Generate coverage report
        id: coverage
        run: |
          echo "üìä Generating test coverage..."
          clojure -M:coverage
        continue-on-error: true  # Don't fail build if coverage fails

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./target/coverage/codecov.json
          flags: backend
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

      - name: Build backend
        run: clojure -X:uberjar

      - name: Upload build artifacts
        if: always()  # Upload even if previous steps failed
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            target/lasso.jar
            resources/public/js/
            resources/public/css/tailwind.css
            lint-results.txt
            target/coverage/
          retention-days: 7

      - name: Generate build summary
        if: always()
        run: |
          echo "## üîç Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test results
          echo "### üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          BACKEND_STATUS="${{ steps.backend-test.outcome }}"
          FRONTEND_STATUS="${{ steps.frontend-test.outcome }}"

          if [ "$BACKEND_STATUS" == "success" ]; then
            echo "- Backend tests: ‚úÖ Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Backend tests: ‚ùå Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$FRONTEND_STATUS" == "success" ]; then
            echo "- Frontend tests: ‚úÖ Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Frontend tests: ‚ùå Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage results
          if [ -f target/coverage/codecov.json ]; then
            echo "### üìä Test Coverage" >> $GITHUB_STEP_SUMMARY
            echo "Coverage report generated. See artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Linting results
          echo "### Linting Results" >> $GITHUB_STEP_SUMMARY
          if [ -f lint-results.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat lint-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build artifacts
          echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Backend JAR: \`target/lasso.jar\`" >> $GITHUB_STEP_SUMMARY
          if [ -f target/lasso.jar ]; then
            JAR_SIZE=$(du -h target/lasso.jar | cut -f1)
            echo "  - Size: $JAR_SIZE" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- Frontend JS: \`resources/public/js/main.js\`" >> $GITHUB_STEP_SUMMARY
          if [ -f resources/public/js/main.js ]; then
            JS_SIZE=$(du -h resources/public/js/main.js | cut -f1)
            echo "  - Size: $JS_SIZE" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- CSS: \`resources/public/css/tailwind.css\`" >> $GITHUB_STEP_SUMMARY
          if [ -f resources/public/css/tailwind.css ]; then
            CSS_SIZE=$(du -h resources/public/css/tailwind.css | cut -f1)
            echo "  - Size: $CSS_SIZE" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Calculate and report duration
        id: duration
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Calculate current run duration
          END_TIME=$(date +%s)
          START_TIME=${{ steps.start-time.outputs.start }}
          DURATION=$((END_TIME - START_TIME))
          DURATION_MIN=$((DURATION / 60))
          DURATION_SEC=$((DURATION % 60))

          echo "## ‚è±Ô∏è CI Duration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**This run:** ${DURATION_MIN}m ${DURATION_SEC}s (${DURATION}s total)" >> $GITHUB_STEP_SUMMARY

          # Fetch historical average (last 10 successful runs)
          if command -v gh &> /dev/null; then
            RECENT_RUNS=$(gh run list --workflow=ci.yml --limit 10 --json conclusion,createdAt,updatedAt --jq '[.[] | select(.conclusion == "success") | (((.updatedAt | fromdateiso8601) - (.createdAt | fromdateiso8601)))] | add / length | floor')

            if [ -n "$RECENT_RUNS" ] && [ "$RECENT_RUNS" != "null" ]; then
              AVG_MIN=$((RECENT_RUNS / 60))
              AVG_SEC=$((RECENT_RUNS % 60))
              echo "**Historical average:** ${AVG_MIN}m ${AVG_SEC}s (${RECENT_RUNS}s total, last 10 runs)" >> $GITHUB_STEP_SUMMARY

              # Show comparison
              DIFF=$((DURATION - RECENT_RUNS))
              if [ $DIFF -gt 0 ]; then
                echo "**Status:** üê¢ ${DIFF}s slower than average" >> $GITHUB_STEP_SUMMARY
              elif [ $DIFF -lt 0 ]; then
                DIFF_ABS=$((DIFF * -1))
                echo "**Status:** üöÄ ${DIFF_ABS}s faster than average" >> $GITHUB_STEP_SUMMARY
              else
                echo "**Status:** ‚úÖ Right on average" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi

          # Save duration for pr-status-comment job
          echo "duration=${DURATION}" >> $GITHUB_OUTPUT

  docker-build:
    runs-on: ubuntu-latest
    needs: lint-and-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: lasso:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/lasso-image.tar

      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ github.sha }}
          path: /tmp/lasso-image.tar
          retention-days: 3

      - name: Inspect Docker image
        run: |
          docker load --input /tmp/lasso-image.tar
          docker images lasso:ci-${{ github.sha }}

          echo "## üê≥ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`lasso:ci-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

          # Get image size
          IMAGE_SIZE=$(docker images lasso:ci-${{ github.sha }} --format "{{.Size}}")
          echo "**Size:** $IMAGE_SIZE" >> $GITHUB_STEP_SUMMARY

          # Show layers
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Layers" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker history lasso:ci-${{ github.sha }} --no-trunc >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

  pr-status-comment:
    runs-on: ubuntu-latest
    needs: [lint-and-build, docker-build]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Comment PR with results
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.lint-and-build.result }}' === 'success' && '${{ needs.docker-build.result }}' === 'success' ? '‚úÖ Success' : '‚ùå Failed';
            const lintStatus = '${{ needs.lint-and-build.result }}' === 'success' ? '‚úÖ Passed' : '‚ùå Failed';
            const dockerStatus = '${{ needs.docker-build.result }}' === 'success' ? '‚úÖ Passed' : '‚ùå Failed';

            // Calculate duration
            const duration = '${{ needs.lint-and-build.outputs.duration }}';
            let durationText = '';
            if (duration && duration !== '') {
              const durationSec = parseInt(duration);
              const minutes = Math.floor(durationSec / 60);
              const seconds = durationSec % 60;
              durationText = `‚è±Ô∏è **Duration:** ${minutes}m ${seconds}s`;
            }

            const body = `## CI Build Status: ${status}

            **Commit:** \`${{ github.sha }}\`
            **Branch:** \`${{ github.head_ref }}\`
            ${durationText ? '\n' + durationText : ''}

            ### Results
            - **Lint & Build:** ${lintStatus}
            - **Backend Tests:** Included in build step
            - **Frontend Tests:** Included in build step
            - **Docker Build:** ${dockerStatus}

            ### Test Coverage
            Coverage reports are generated and available in the workflow artifacts.

            ### Details
            View the full [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed logs, test results, and coverage reports.

            ${status.includes('‚ùå') ? '‚ö†Ô∏è **Action Required:** Please review the failed checks and push fixes to this branch. CI will automatically re-run on push.' : '‚ú® **Ready for Review:** All checks passed! This PR is ready for human review.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
